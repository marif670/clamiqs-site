<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calmiqs Blog Editor</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { primary: "#4FA49A", accent: "#FFD580", tech: "#5A67D8" },
            fontFamily: { sans: ["Poppins", "sans-serif"] },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="/assets/css/style.css?v=12" />
  </head>
  <body class="bg-[#F9FAFB] text-gray-800 font-sans min-h-screen">
    <!-- üîí Login Section -->
    <section id="authSection" class="flex items-center justify-center min-h-screen">
      <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md text-center">
        <h1 class="text-3xl font-bold text-primary mb-4">üîí Calmiqs Admin Login</h1>
        <input
          id="passwordInput"
          type="password"
          placeholder="Enter password"
          class="w-full border rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-primary"
        />
        <button
          id="loginBtn"
          class="bg-primary hover:bg-tech text-white font-medium px-6 py-2 rounded-lg transition w-full"
        >
          Login
        </button>
      </div>
    </section>

    <!-- üìù Editor Section -->
    <section id="editorSection" class="hidden max-w-5xl mx-auto p-6">
      <h1 class="text-4xl font-bold text-primary mb-6 text-center">ü™∂ Calmiqs Blog Editor</h1>

      <!-- File Controls -->
      <div class="flex justify-between items-center mb-4">
        <button
          id="loadBtn"
          class="bg-accent text-gray-800 px-4 py-2 rounded-lg shadow hover:bg-yellow-400 transition"
        >
          Load Posts
        </button>
        <div class="flex gap-2">
          <button
            id="saveBtn"
            class="bg-primary text-white px-4 py-2 rounded-lg shadow hover:bg-tech transition"
          >
            Save Post
          </button>
          <button
            id="deleteBtn"
            class="bg-red-500 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition"
          >
            Delete Post
          </button>
        </div>
      </div>

      <!-- Posts Dropdown -->
      <div class="mb-4">
        <label for="postSelect" class="block text-sm font-medium mb-1">Select Post:</label>
        <select
          id="postSelect"
          class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        ></select>
      </div>

      <!-- Editor Form -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left Column -->
        <div>
          <label class="block text-sm font-medium mb-1">Post Key (slug)</label>
          <input
            id="key"
            type="text"
            placeholder="e.g., mindful-breathing"
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />

          <label class="block text-sm font-medium mb-1">Title</label>
          <input
            id="title"
            type="text"
            placeholder="Article title"
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />

          <label class="block text-sm font-medium mb-1">Date</label>
          <input
            id="date"
            type="text"
            placeholder="e.g., November 4, 2025"
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />

          <label class="block text-sm font-medium mb-1">Hero Image</label>
          <input
            id="image"
            type="text"
            placeholder="https://..."
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />
          <label class="block text-sm font-medium mb-1">Hero Image Alt Text</label>
          <input
            id="imageAlt"
            type="text"
            placeholder="Describe the hero image"
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          />

          <label class="block text-sm font-medium mb-1">Upload Inline Image</label>
          <input id="inlineImageFile" type="file" class="mb-2" />
          <input
            id="inlineImageAlt"
            type="text"
            placeholder="Alt text for inline image"
            class="w-full border rounded-lg px-4 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-primary"
          />
          <button
            id="uploadInlineBtn"
            class="bg-accent text-gray-800 px-4 py-2 rounded-lg shadow hover:bg-yellow-400 transition mb-6"
          >
            Upload Inline Image
          </button>
        </div>

        <!-- Right Column -->
        <div>
          <label class="block text-sm font-medium mb-1">Excerpt</label>
          <textarea
            id="excerpt"
            rows="3"
            placeholder="Short preview text..."
            class="w-full border rounded-lg px-4 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-primary"
          ></textarea>

          <label class="block text-sm font-medium mb-1">Content (HTML allowed)</label>
          <textarea
            id="content"
            rows="10"
            placeholder="<p>Your article here...</p>"
            class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          ></textarea>
        </div>
      </div>

      <!-- Toggle Preview -->
      <button
        onclick="document.getElementById('previewContainer').classList.toggle('hidden')"
        class="mt-6 bg-primary text-white px-4 py-2 rounded-lg hover:bg-tech transition"
      >
        Toggle Preview
      </button>

      <!-- ü™∂ Live Preview -->
      <h2 class="text-2xl font-semibold mt-8 mb-4">ü™∂ Live Preview</h2>
      <div id="previewContainer" class="bg-white shadow-lg rounded-xl p-6 border border-gray-100">
        <div id="previewContent" class="prose max-w-none"></div>
      </div>
    </section>

    <script>
      const PASSWORD = "calmiqs2025";
      const KV_URL = "/posts"; // KV function endpoint
      let posts = {};

      const authSection = document.getElementById("authSection");
      const editorSection = document.getElementById("editorSection");
      const passwordInput = document.getElementById("passwordInput");
      const loginBtn = document.getElementById("loginBtn");
      const postSelect = document.getElementById("postSelect");
      const saveBtn = document.getElementById("saveBtn");
      const deleteBtn = document.getElementById("deleteBtn");

      // Hero + content fields
      const titleInput = document.getElementById("title");
      const dateInput = document.getElementById("date");
      const imageInput = document.getElementById("image");
      const imageAltInput = document.getElementById("imageAlt");
      const contentInput = document.getElementById("content");
      const preview = document.getElementById("previewContent");

      // Inline image
      const inlineFileInput = document.getElementById("inlineImageFile");
      const inlineAltInput = document.getElementById("inlineImageAlt");
      const uploadInlineBtn = document.getElementById("uploadInlineBtn");

      // === Login ===
      loginBtn.addEventListener("click", () => {
        if (passwordInput.value.trim() === PASSWORD) {
          sessionStorage.setItem("calmiqsAuth", "true");
          authSection.classList.add("hidden");
          editorSection.classList.remove("hidden");
          loadPosts();
        } else alert("Incorrect password.");
      });

      if (sessionStorage.getItem("calmiqsAuth") === "true") {
        authSection.classList.add("hidden");
        editorSection.classList.remove("hidden");
        loadPosts();
      }

      // === KV Posts Integration ===
      async function loadPosts() {
        try {
          const res = await fetch(KV_URL);
          posts = await res.json();
          populateSelect();
        } catch {
          alert("‚ùå Could not load posts from KV.");
        }
      }

      function populateSelect() {
        postSelect.innerHTML =
          '<option value="">‚ûï New Post</option>' +
          Object.keys(posts)
            .map((k) => `<option value="${k}">${k}</option>`)
            .join("");
      }

      postSelect.addEventListener("change", () => {
        const key = postSelect.value;
        if (!key) return clearForm();
        const post = posts[key];
        document.getElementById("key").value = key;
        ["title", "date", "image", "imageAlt", "excerpt", "content"].forEach((id) => {
          document.getElementById(id).value = post[id] || "";
        });
        updatePreview();
      });

      function clearForm() {
        document.getElementById("key").value = "";
        ["title", "date", "image", "imageAlt", "excerpt", "content"].forEach((id) => {
          document.getElementById(id).value = "";
        });
        updatePreview();
      }

      // === Save / Delete Posts ===
      async function savePost() {
        const key = document.getElementById("key").value.trim();
        if (!key) return alert("Provide a key (slug).");
        const data = ["title", "date", "image", "excerpt", "content"].reduce((obj, id) => {
          obj[id] = document.getElementById(id).value.trim();
          return obj;
        }, {});
        data.imageAlt = document.getElementById("imageAlt").value.trim();

        try {
          const res = await fetch(KV_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ key, data }),
          });
          const result = await res.json();
          if (result.success) {
            alert("‚úÖ Post saved!");
            loadPosts();
          } else alert("‚ö†Ô∏è Error: " + (result.error || "Unknown"));
        } catch {
          alert("‚ùå Failed to save post.");
        }
      }

      async function deletePost() {
        const key = postSelect.value;
        if (!key) return alert("Select a post to delete");
        if (!confirm(`Delete '${key}'?`)) return;
        try {
          const res = await fetch(`${KV_URL}?key=${encodeURIComponent(key)}`, { method: "DELETE" });
          const result = await res.json();
          if (result.success) {
            alert("üóëÔ∏è Post deleted");
            clearForm();
            loadPosts();
          } else alert("‚ö†Ô∏è Error: " + (result.error || "Unknown"));
        } catch {
          alert("‚ùå Failed to delete post.");
        }
      }

      // === Live Preview ===
      function updatePreview() {
        const title = titleInput.value || "Untitled Post";
        const date = dateInput.value || "No date";
        const image = imageInput.value || "https://via.placeholder.com/800x400?text=Preview";
        const imageAlt = imageAltInput.value || "Preview image";
        const content = contentInput.value || "<p>Start typing...</p>";

        preview.innerHTML = `
      <img src="${image}" alt="${imageAlt}" class="rounded-xl mb-4 shadow-md w-full max-h-96 object-cover" />
      <h3 class="text-3xl font-bold mb-2 text-primary">${title}</h3>
      <p class="text-gray-500 mb-6">${date}</p>
      <div class="text-gray-800 leading-relaxed">${content}</div>
    `;
      }

      [titleInput, dateInput, imageInput, imageAltInput, contentInput].forEach((el) =>
        el.addEventListener("input", updatePreview)
      );
      updatePreview();

      // === Inline Image Upload ===
      uploadInlineBtn.addEventListener("click", async () => {
        const file = inlineFileInput.files[0];
        const alt = inlineAltInput.value.trim();
        if (!file) return alert("Select a file");
        if (!alt) return alert("Provide alt text");

        const formData = new FormData();
        formData.append("file", file);
        formData.append("alt", alt);

        try {
          const res = await fetch("/images/upload", { method: "POST", body: formData });
          const json = await res.json();
          if (!json.success) return alert("‚ùå Upload failed: " + (json.error || "Unknown"));

          // Insert uploaded inline image
          const contentBox = document.getElementById("content");
          const cursorPos = contentBox.selectionStart;
          const template = `<img src="${json.url}" alt="${json.alt}" class="my-4 rounded-lg shadow-md" />`;
          contentBox.value =
            contentBox.value.slice(0, cursorPos) + template + contentBox.value.slice(cursorPos);
          updatePreview();
          alert("‚úÖ Inline image uploaded");
          inlineFileInput.value = "";
          inlineAltInput.value = "";
        } catch (err) {
          console.error(err);
          alert("‚ùå Failed to upload image");
        }
      });

      // === Event Listeners ===
      document.getElementById("loadBtn").addEventListener("click", loadPosts);
      saveBtn.addEventListener("click", savePost);
      deleteBtn.addEventListener("click", deletePost);
    </script>
  </body>
</html>
