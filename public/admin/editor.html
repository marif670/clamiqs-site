<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Calmiqs Editor — Final</title>
    <style>
      /* Colored theme, compact UI */
      :root {
        --bg: #0f1724;
        --card: #ffffff;
        --muted: #64748b;
        --accent: #2563eb;
        --accent-2: #06b6d4;
        --border: #e6eef8;
        --danger: #dc2626;
      }
      body {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        margin: 16px;
        background: #f8fafc;
        color: #0f1724;
      }
      header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: #fff;
        cursor: pointer;
      }
      .btn.primary {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }
      .btn.ghost {
        background: transparent;
      }
      .input {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid var(--border);
        width: 100%;
      }
      .layout {
        display: flex;
        gap: 12px;
      }
      .col {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
      }
      .left {
        flex: 1;
      }
      .right {
        width: 360px;
      }
      .editor {
        min-height: 380px;
        border: 1px dashed #dbe7f0;
        padding: 10px;
        border-radius: 6px;
        overflow: auto;
      }
      .editor:focus {
        outline: 2px solid rgba(37, 99, 235, 0.12);
      }
      .meta-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .small {
        font-size: 13px;
        color: var(--muted);
      }
      .inline-img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        display: block;
        margin: 12px auto;
      }
      .inline-img.left {
        float: left;
        margin: 0 12px 12px 0;
      }
      .inline-img.right {
        float: right;
        margin: 0 0 12px 12px;
      }
      .inline-img.center {
        display: block;
        margin: 12px auto;
      }
      .img-selected {
        outline: 3px solid rgba(37, 99, 235, 0.25);
      }
      .toolbar-2 {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }
      #preview {
        background: #fff;
        border: 1px solid var(--border);
        padding: 12px;
        border-radius: 8px;
        min-height: 220px;
        margin-top: 12px;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .modal-card {
        background: white;
        border-radius: 8px;
        padding: 12px;
        max-width: 1000px;
        width: 92%;
        max-height: 80vh;
        overflow: auto;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }
      .thumb {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid #e6eef8;
      }
      .inline-toolbar {
        position: absolute;
        background: #fff;
        border: 1px solid var(--border);
        padding: 8px;
        border-radius: 6px;
        z-index: 3000;
        box-shadow: 0 6px 20px rgba(2, 6, 23, 0.08);
      }
      .html-view {
        width: 100%;
        min-height: 160px;
        font-family: monospace;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid var(--border);
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .danger {
        color: var(--danger);
      }
      footer {
        margin-top: 12px;
        font-size: 13px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Calmiqs Editor</h1>
      <div class="toolbar" style="margin-left: auto">
        <button id="newPostBtn" class="btn">New</button>
        <button id="loadPostBtn" class="btn">Load</button>
        <button id="openPostsBtn" class="btn">Posts Library</button>
        <button id="savePostBtn" class="btn primary">Save</button>
        <button id="deletePostBtn" class="btn danger">Delete</button>
      </div>
    </header>

    <!-- IMPORTANT: Set your ADMIN SECRET here (must match Worker ADMIN_SECRET) -->
    <script>
      window.CALMIQS_ADMIN_TOKEN = "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Hadia@2017_Ayesha@2007";
      const WORKER_BASE = "https://calmiqs-images-worker.techaipet.workers.dev";
      const UPLOAD_URL = WORKER_BASE + "/upload";
      const LIST_URL = WORKER_BASE + "/list";
      const UPDATE_URL = WORKER_BASE + "/update";
      const POSTS_URL = WORKER_BASE + "/posts";
      const FILES_BASE = WORKER_BASE + "/files/";
    </script>

    <!-- top metadata + layout -->
    <div class="layout" style="align-items: flex-start">
      <!-- left column: inputs -->
      <div class="col left">
        <div style="margin-bottom: 10px">
          <input id="postTitle" class="input" placeholder="Post title" />
          <div class="small" style="margin-top: 6px">Slug auto-generated from title on save</div>
        </div>

        <!-- formatting toolbar -->
        <div class="toolbar-2">
          <button class="btn" data-cmd="bold"><b>B</b></button>
          <button class="btn" data-cmd="italic"><i>I</i></button>
          <button class="btn" data-cmd="h1">H1</button>
          <button class="btn" data-cmd="h2">H2</button>
          <button class="btn" data-cmd="h3">H3</button>
          <button class="btn" data-cmd="p">P</button>
          <button class="btn" data-cmd="link">Link</button>
          <button id="insertTableBtn" class="btn">Table</button>
          <div style="flex: 1"></div>
          <button id="toggleHtmlBtn" class="btn">Show HTML</button>
        </div>

        <!-- editable area -->
        <div id="editor" class="editor" contenteditable="true" aria-label="Article editor">
          <p>Start writing the post here...</p>
        </div>

        <!-- inline image controls -->
        <div style="display: flex; gap: 8px; align-items: center; margin-top: 10px">
          <input id="inlineImageFile" type="file" accept="image/*" />
          <button id="uploadInsertBtn" class="btn">Upload & Insert</button>
          <button id="openLibraryBtn" class="btn">Select from Library</button>
        </div>

        <!-- HTML raw view -->
        <div id="htmlViewWrap" style="display: none; margin-top: 10px">
          <label class="small">Raw HTML</label>
          <textarea id="htmlView" class="html-view"></textarea>
        </div>
      </div>

      <!-- right column: hero + image options, meta -->
      <aside class="col right">
        <div style="margin-bottom: 10px">
          <label class="small">Hero Image</label>
          <input id="heroFile" type="file" accept="image/*" style="margin-top: 6px" />
          <input
            id="heroAlt"
            class="input"
            placeholder="Hero image alt text"
            style="margin-top: 8px"
          />
          <button id="uploadHeroBtn" class="btn" style="margin-top: 8px">Upload Hero Image</button>
        </div>

        <div style="margin-top: 12px">
          <label class="small">Excerpt</label>
          <textarea
            id="postExcerpt"
            class="input"
            style="min-height: 90px; margin-top: 6px"
          ></textarea>
        </div>

        <div style="margin-top: 12px">
          <label class="small">Options</label>
          <div style="margin-top: 8px">
            <label class="small">
              <input type="checkbox" id="autosaveToggle" checked />
              Auto-save every 60s
            </label>
          </div>
          <div style="margin-top: 8px">
            <label class="small">Default inserted image width</label>
            <input id="defaultImageWidth" class="input" placeholder="80% or 500px" value="80%" />
          </div>
        </div>
      </aside>
    </div>

    <!-- library modal -->
    <div id="libraryModal" class="modal" style="display: none">
      <div class="modal-card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <strong>Image Library</strong>
          <div><button id="closeLibraryBtn" class="btn">Close</button></div>
        </div>
        <div id="libraryGrid" class="grid"></div>
      </div>
    </div>

    <!-- inline floating toolbar for image edits -->
    <div id="imgToolbar" class="inline-toolbar" style="display: none">
      <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center">
        <input id="imgUrlField" class="input" placeholder="Image URL" style="width: 260px" />
        <input id="imgAltField" class="input" placeholder="Alt text" style="width: 180px" />
        <input
          id="imgWidthField"
          class="input"
          placeholder="Width (px or %)"
          style="width: 120px"
        />
        <div style="display: flex; gap: 6px; align-items: center">
          <button id="wrapLeftBtn" class="btn">Wrap Left</button>
          <button id="wrapRightBtn" class="btn">Wrap Right</button>
          <button id="wrapCenterBtn" class="btn">Center</button>
        </div>
        <button id="saveImgMetaBtn" class="btn primary">Save</button>
      </div>
    </div>

    <!-- preview below (stacked) -->
    <div id="preview" aria-live="polite" style="margin-top: 16px"></div>

    <footer>
      <div class="muted">
        Tip: Use Show HTML to view/edit raw tags. Save to persist drafts to Cloudflare KV.
      </div>
    </footer>

    <script>
      /* =========================
     Calmiqs Final Editor JS
     - Uses Worker endpoints set above
     - Replace ADMIN token string above before using
     ========================= */

      (function () {
        // Basic elements
        const editor = document.getElementById("editor");
        const preview = document.getElementById("preview");
        const htmlViewWrap = document.getElementById("htmlViewWrap");
        const htmlView = document.getElementById("htmlView");
        const toggleHtmlBtn = document.getElementById("toggleHtmlBtn");

        const uploadInsertBtn = document.getElementById("uploadInsertBtn");
        const inlineFile = document.getElementById("inlineImageFile");
        const openLibraryBtn = document.getElementById("openLibraryBtn");
        const libraryModal = document.getElementById("libraryModal");
        const libraryGrid = document.getElementById("libraryGrid");
        const closeLibraryBtn = document.getElementById("closeLibraryBtn");

        const imgToolbar = document.getElementById("imgToolbar");
        const imgUrlField = document.getElementById("imgUrlField");
        const imgAltField = document.getElementById("imgAltField");
        const imgWidthField = document.getElementById("imgWidthField");
        const wrapLeftBtn = document.getElementById("wrapLeftBtn");
        const wrapRightBtn = document.getElementById("wrapRightBtn");
        const wrapCenterBtn = document.getElementById("wrapCenterBtn");
        const saveImgMetaBtn = document.getElementById("saveImgMetaBtn");

        const postTitle = document.getElementById("postTitle");
        const newPostBtn = document.getElementById("newPostBtn");
        const loadPostBtn = document.getElementById("loadPostBtn");
        const savePostBtn = document.getElementById("savePostBtn");
        const deletePostBtn = document.getElementById("deletePostBtn");
        const postExcerpt = document.getElementById("postExcerpt");
        const defaultImageWidth = document.getElementById("defaultImageWidth");
        const autosaveToggle = document.getElementById("autosaveToggle");

        const heroFile = document.getElementById("heroFile");
        const heroAlt = document.getElementById("heroAlt");
        const uploadHeroBtn = document.getElementById("uploadHeroBtn");

        // state
        let selectedImageEl = null;
        let editingImageId = null; // if image metadata stored with id/r2Key
        let autosaveTimer = null;
        const AUTOSAVE_INTERVAL_MS = 60000; // 60s

        // helper: auth fetch
        async function authFetch(url, opts = {}) {
          opts.headers = opts.headers || {};
          if (window.CALMIQS_ADMIN_TOKEN)
            opts.headers["X-Admin-Token"] = window.CALMIQS_ADMIN_TOKEN;
          return fetch(url, opts);
        }

        // formatting toolbar (execCommand)
        document.querySelectorAll("[data-cmd]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const cmd = btn.dataset.cmd;
            if (cmd === "link") {
              const url = prompt("Enter URL (https://...)");
              if (url) document.execCommand("createLink", false, url);
            } else if (["h1", "h2", "h3", "p"].includes(cmd)) {
              document.execCommand("formatBlock", false, cmd);
            } else {
              document.execCommand(cmd, false, null);
            }
            updatePreview();
          });
        });

        // insert table
        document.getElementById("insertTableBtn").addEventListener("click", () => {
          const rows = parseInt(prompt("Rows", "2"), 10) || 2;
          const cols = parseInt(prompt("Columns", "3"), 10) || 3;
          const table = document.createElement("table");
          const tbody = document.createElement("tbody");
          for (let r = 0; r < rows; r++) {
            const tr = document.createElement("tr");
            for (let c = 0; c < cols; c++) {
              const td = document.createElement("td");
              td.innerHTML = "&nbsp;";
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          insertAtCursor(table);
          updatePreview();
        });

        // toggle html raw view
        toggleHtmlBtn.addEventListener("click", () => {
          if (htmlViewWrap.style.display === "none" || htmlViewWrap.style.display === "") {
            htmlView.value = editor.innerHTML;
            htmlViewWrap.style.display = "block";
            toggleHtmlBtn.textContent = "Hide HTML";
          } else {
            editor.innerHTML = htmlView.value;
            htmlViewWrap.style.display = "none";
            toggleHtmlBtn.textContent = "Show HTML";
            updatePreview();
          }
        });

        // editor change -> preview
        const debouncedPreview = debounce(updatePreview, 200);
        editor.addEventListener("input", () => {
          debouncedPreview();
        });
        editor.addEventListener("keyup", () => {
          debouncedPreview();
        });

        function updatePreview() {
          preview.innerHTML = editor.innerHTML;
        }

        // insertAtCursor — accepts Element or Node
        function insertAtCursor(node) {
          const sel = window.getSelection();
          if (!sel || !sel.rangeCount) {
            editor.appendChild(node);
            return;
          }
          const range = sel.getRangeAt(0);
          range.deleteContents();
          range.insertNode(node);
          range.setStartAfter(node);
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
          editor.focus();
          ensureParagraphAfter(node);
          updatePreview();
        }

        function ensureParagraphAfter(node) {
          // ensure node is valid and inside editor
          const el = node.nodeType === 1 ? node : node.parentNode;
          if (!el || !el.parentNode || !editor.contains(el)) return;
          const next = el.nextSibling;
          if (
            !next ||
            next.nodeType === 3 ||
            (next.nodeName && next.nodeName.toLowerCase() !== "p")
          ) {
            const p = document.createElement("p");
            p.innerHTML = "<br>";
            el.parentNode.insertBefore(p, el.nextSibling);
          }
        }

        // ---------- IMAGE UPLOAD & LIBRARY ----------
        // Upload & insert inline
        uploadInsertBtn.addEventListener("click", async () => {
          if (!inlineFile.files || inlineFile.files.length === 0)
            return alert("Choose a file first");
          await uploadFileAndInsert(inlineFile.files[0]);
        });

        inlineFile.addEventListener("change", async () => {
          if (inlineFile.files && inlineFile.files[0]) {
            // auto-upload on choose
            await uploadFileAndInsert(inlineFile.files[0]);
          }
        });

        async function uploadFileAndInsert(file) {
          try {
            const fd = new FormData();
            fd.append("file", file);
            const res = await authFetch(UPLOAD_URL, { method: "POST", body: fd });
            const json = await res.json();
            if (!res.ok) throw new Error(json.error || JSON.stringify(json));
            // expect json.metadata.r2Key and json.url (or construct)
            const url = json.url || FILES_BASE + encodeURIComponent(json.metadata.r2Key);
            const img = document.createElement("img");
            img.src = url;
            img.alt = json.metadata.alt || file.name;
            img.className = "inline-img";
            img.dataset.r2key = json.metadata.r2Key || json.metadata.r2Key;
            img.dataset.id = json.metadata.r2Key || "";
            // default width
            const defW = defaultImageWidth.value || "80%";
            img.style.width = defW;
            attachImageHandlers(img);
            insertAtCursor(img);
          } catch (err) {
            console.error(err);
            alert("Image upload failed: " + (err.message || err));
          }
        }

        // Library modal handlers
        openLibraryBtn.addEventListener("click", openLibrary);
        closeLibraryBtn.addEventListener("click", () => {
          libraryModal.style.display = "none";
        });

        async function openLibrary() {
          libraryGrid.innerHTML =
            '<div style="grid-column:1/-1;padding:18px;text-align:center">Loading…</div>';
          libraryModal.style.display = "flex";
          try {
            const res = await authFetch(LIST_URL);
            const json = await res.json();
            if (!res.ok) throw new Error(json.error || "Failed to load");
            libraryGrid.innerHTML = "";
            const arr = json.images || [];
            if (arr.length === 0) {
              libraryGrid.innerHTML =
                '<div style="grid-column:1/-1;padding:18px;text-align:center">No images</div>';
              return;
            }
            arr.forEach((item) => {
              const thumb = document.createElement("img");
              // item.r2Key expected in metadata
              const key = item.r2Key || item.r2Key || item.key || item.filename;
              thumb.src = FILES_BASE + encodeURIComponent(key);
              thumb.className = "thumb";
              thumb.alt = item.alt || item.title || item.filename || "";
              thumb.title = item.title || item.filename || "";
              thumb.addEventListener("click", () => {
                const img = document.createElement("img");
                img.src = thumb.src;
                img.alt = thumb.alt || "";
                img.className = "inline-img";
                img.dataset.r2key = key;
                attachImageHandlers(img);
                insertAtCursor(img);
                libraryModal.style.display = "none";
              });
              libraryGrid.appendChild(thumb);
            });
          } catch (err) {
            console.error(err);
            libraryGrid.innerHTML =
              '<div style="grid-column:1/-1;padding:12px;color:#d04437">Failed to load library</div>';
          }
        }

        // image handlers: click to show toolbar, attach resize handle if wanted
        function attachImageHandlers(img) {
          img.addEventListener("click", (ev) => {
            ev.stopPropagation();
            // select image visually
            document
              .querySelectorAll(".inline-img")
              .forEach((i) => i.classList.remove("img-selected"));
            img.classList.add("img-selected");
            selectedImageEl = img;
            // show toolbar near image
            const rect = img.getBoundingClientRect();
            imgToolbar.style.left = rect.left + window.scrollX + "px";
            imgToolbar.style.top = rect.bottom + window.scrollY + 8 + "px";
            imgToolbar.style.display = "block";
            imgUrlField.value = img.src;
            imgAltField.value = img.alt || "";
            imgWidthField.value = img.style.width || "";
          });
          // ensure paragraph after to allow typing
          ensureParagraphAfter(img);
        }

        // save image meta (do not require id; if r2Key present update KV)
        saveImgMetaBtn.addEventListener("click", async () => {
          if (!selectedImageEl) return;
          selectedImageEl.src = imgUrlField.value.trim() || selectedImageEl.src;
          selectedImageEl.alt = imgAltField.value.trim();
          const w = imgWidthField.value.trim();
          if (w) {
            selectedImageEl.style.width =
              w.endsWith("%") || w.endsWith("px") ? w : isNaN(Number(w)) ? w : w + "px";
          } else {
            selectedImageEl.style.removeProperty("width");
          }
          imgToolbar.style.display = "none";
          // if r2Key exists, update KV via worker /update
          const r2key = selectedImageEl.dataset.r2key;
          if (r2key) {
            try {
              await authFetch(UPDATE_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  r2Key: r2key,
                  alt: selectedImageEl.alt,
                  title: selectedImageEl.alt,
                }),
              });
            } catch (e) {
              console.warn("metadata update failed", e);
            }
          }
          updatePreview();
        });

        wrapLeftBtn.addEventListener("click", () => {
          if (!selectedImageEl) return;
          selectedImageEl.className = "inline-img left";
          imgToolbar.style.display = "none";
          updatePreview();
        });
        wrapRightBtn.addEventListener("click", () => {
          if (!selectedImageEl) return;
          selectedImageEl.className = "inline-img right";
          imgToolbar.style.display = "none";
          updatePreview();
        });
        wrapCenterBtn.addEventListener("click", () => {
          if (!selectedImageEl) return;
          selectedImageEl.className = "inline-img center";
          imgToolbar.style.display = "none";
          updatePreview();
        });

        // hide toolbar when clicking outside
        document.addEventListener("click", (e) => {
          if (!imgToolbar.contains(e.target)) {
            imgToolbar.style.display = "none";
            document
              .querySelectorAll(".inline-img")
              .forEach((i) => i.classList.remove("img-selected"));
            selectedImageEl = null;
          }
        });

        // ---------- HERO IMAGE UPLOAD ----------
        uploadHeroBtn.addEventListener("click", async () => {
          if (!heroFile.files || !heroFile.files[0]) return alert("Choose hero image first");
          const f = heroFile.files[0];
          try {
            const fd = new FormData();
            fd.append("file", f);
            fd.append("title", "hero");
            fd.append("alt", heroAlt.value || "");
            const res = await authFetch(UPLOAD_URL, { method: "POST", body: fd });
            const j = await res.json();
            if (!res.ok) throw new Error(j.error || "Upload failed");
            alert(
              "Hero uploaded — you can insert via library or use the URL: " +
                (j.url || ".../files/" + encodeURIComponent(j.metadata.r2Key))
            );
          } catch (err) {
            console.error(err);
            alert("Hero upload failed: " + (err.message || err));
          }
        });

        // ---------- POSTS (CRUD) ----------
        newPostBtn.addEventListener("click", () => {
          postTitle.value = "";
          editor.innerHTML = "<p></p>";
          postExcerpt.value = "";
          updatePreview();
        });
        loadPostBtn.addEventListener("click", async () => {
          const slug = prompt("Enter slug to load");
          if (!slug) return;
          try {
            const res = await authFetch(POSTS_URL + "/" + encodeURIComponent(slug));
            if (!res.ok) return alert("Not found");
            const j = await res.json();
            postTitle.value = j.title || "";
            editor.innerHTML = j.content || "";
            postExcerpt.value = j.excerpt || "";
            updatePreview();
          } catch (e) {
            console.error(e);
            alert("Load failed");
          }
        });

        savePostBtn.addEventListener("click", savePostNow);
        deletePostBtn.addEventListener("click", async () => {
          const slug = prompt("Enter slug to delete");
          if (!slug) return;
          if (!confirm("Delete post " + slug + "?")) return;
          try {
            const res = await authFetch(POSTS_URL + "/" + encodeURIComponent(slug), {
              method: "DELETE",
            });
            if (res.ok) alert("Deleted");
            else alert("Delete failed");
          } catch (e) {
            console.error(e);
            alert("Delete failed");
          }
        });

        async function savePostNow() {
          const title = postTitle.value.trim();
          if (!title) return alert("Enter a title first");
          const slug = title
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/(^-|-$)/g, "");
          const payload = {
            title: title,
            slug: slug,
            content: editor.innerHTML,
            excerpt: postExcerpt.value,
          };
          try {
            const res = await authFetch(POSTS_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (res.ok) {
              alert("Saved");
            } else {
              const j = await res.json();
              alert("Save failed: " + (j.error || JSON.stringify(j)));
            }
          } catch (e) {
            console.error(e);
            alert("Save failed");
          }
        }

        // autosave
        function startAutosave() {
          if (autosaveTimer) clearInterval(autosaveTimer);
          if (!autosaveToggle.checked) return;
          autosaveTimer = setInterval(() => {
            try {
              savePostNow();
            } catch (e) {
              console.warn(e);
            }
          }, AUTOSAVE_INTERVAL_MS);
        }
        autosaveToggle.addEventListener("change", startAutosave);
        startAutosave();

        // ---------- helper utilities ----------
        function debounce(fn, t) {
          let timer;
          return (...a) => {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, a), t);
          };
        }
        function insertAtCursor(el) {
          const sel = window.getSelection();
          if (!sel || !sel.rangeCount) {
            editor.appendChild(el);
            return;
          }
          const range = sel.getRangeAt(0);
          range.deleteContents();
          range.insertNode(el);
          range.setStartAfter(el);
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
          editor.focus();
          ensureParagraphAfter(el);
          updatePreview();
        }

        // attach click handler for images that may already be in the editor on load
        function attachExistingImages() {
          editor.querySelectorAll("img.inline-img, img").forEach((img) => {
            if (!img.dataset._handled) {
              attachImageHandlers(img);
              img.dataset._handled = "1";
            }
          });
        }

        // initial
        updatePreview();
        attachExistingImages();

        // ensure preview updates when window gets focus (helpful after external changes)
        window.addEventListener("focus", () => {
          updatePreview();
        });
      })();
    </script>
  </body>
</html>
